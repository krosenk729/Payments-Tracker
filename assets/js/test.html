<!DOCTYPE html>
<html>
<head>
	<title>Login</title>
	<meta charset="utf-8">
</head>
<body>
	<div style="margin: 0 auto;">
		<button>Let's Make Magic</button>
		<br>
		<input type="text" name="a-thing">
	</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.8.2/firebase.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.8.2/firebase-auth.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyD6FBfO14EljQNaKSud9lHWlsasUita6uY",
    authDomain: "recurring-payments-tracker.firebaseapp.com",
    databaseURL: "https://recurring-payments-tracker.firebaseio.com",
    projectId: "recurring-payments-tracker",
    storageBucket: "recurring-payments-tracker.appspot.com",
    messagingSenderId: "428623070633"
  };
  firebase.initializeApp(config);
  var provider = new firebase.auth.GoogleAuthProvider();
  // provider.addScope('https://www.googleapis.com/auth/contacts.readonly');


  $('button').click(doLoginStuff);
  $('#a-thing').blur(doAddDataStuff);

  ///////////////////////////////////////////////////////

  function doLoginStuff() {
  	firebase.auth().signInWithPopup(provider).then(function(result) {
	  // This gives you a Google Access Token. You can use it to access the Google API.
	  var token = result.credential.accessToken;
	  // The signed-in user info.
	  var user = result.user;
	  console.log('promise from provider ran', result);
	}).catch(function(error) {
	  // Handle Errors here.
	  var errorCode = error.code;
	  var errorMessage = error.message;
	  // The email of the user's account used.
	  var email = error.email;
	  // The firebase.auth.AuthCredential type that was used.
	  var credential = error.credential;
	  
	  console.log('error', error);
	});
  }

  firebase.auth().onAuthStateChanged(function(user) {
	  if (user) {
	    console.log('User is signed in.', user);
	    firebase.database().ref('test/users').child(uid).update({
	    	name: user.displayName,
	    	img: user.photoURL,
	    	id: user.uid 
	    });
	  } else {
	    // No user is signed in.
	  }
	});


  ///////////////////////////////////////////////////////
  function doAddDataStuff(){
  	let newThing = $('#a-thing').val();
  	let dbPathUser = 'test/users/' + firebase.auth().currentUser.uid + '/payments';
  	let dbPathThing = 'test/payments';

  	//{test/users/UID/payments: {PID: true}, test/payments/PID: {thing: thingname, uid: UID}}

  	firebase.database().ref(dbPathUser).update({newThing: true});
  	firebase.database().ref(dbPathThing).push({name: newThing, uid: firebase.auth().currentUser.uid });
  }

  ///////////////////////////////////////////////////////

  function monitorThis(monitorpath = ''){
  	firebase.database().ref().off();
  	firebase.database().ref(monitorpath).on('value', function(data){
  		console.log('on value happened', data);
  	});
  }
  monitorThis('test');

</script>
</body>
</html>